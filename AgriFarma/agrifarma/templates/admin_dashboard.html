{% extends 'base.html' %}
{% block content %}
  <h2 class="mb-3">Shop Admin</h2>
  <div class="row mb-3">
    <div class="col-md-12">
      <div class="card">
        <div class="card-header">Platform Metrics</div>
        <div class="card-body">
          <div class="row text-center mb-3">
            <div class="col">
              <div class="admin-kpi mb-2"><strong>{{ users_count }}</strong><div class="text-muted small">Users</div></div>
            </div>
            <div class="col">
              <div class="admin-kpi mb-2"><strong>{{ products_count }}</strong><div class="text-muted small">Products</div></div>
            </div>
            <div class="col">
              <div class="admin-kpi mb-2"><strong>{{ orders_count }}</strong><div class="text-muted small">Orders</div></div>
            </div>
            <div class="col">
              <div class="admin-kpi mb-2"><strong>{{ pending_posts }}</strong><div class="text-muted small">Pending Posts</div></div>
            </div>
          </div>
          <canvas id="metricsChart" height="120"></canvas>
        </div>
      </div>
    </div>
  </div>
  <div class="row">
    <div class="col-md-5">
      <div class="card mb-3">
        <div class="card-header">Add Product</div>
        <div class="card-body">
          <form method="post">
            {{ form.hidden_tag() }}
            <div class="mb-2">{{ form.name.label }} {{ form.name(class='form-control') }}</div>
            <div class="mb-2">{{ form.description.label }} {{ form.description(class='form-control', rows='3') }}</div>
              <div class="row">
              <div class="col">{{ form.price.label }} {{ form.price(class='form-control') }}</div>
              <div class="col">{{ form.category.label }} {{ form.category(class='form-select') }}</div>
            </div>
            <div class="mb-2">{{ form.images.label }} {{ form.images(class='form-control', placeholder='img1.jpg,img2.jpg') }}</div>
            <div class="row">
              <div class="col">{{ form.inventory.label }} {{ form.inventory(class='form-control') }}</div>
              <div class="col">{{ form.status.label }} {{ form.status(class='form-select') }}</div>
            </div>
            <div class="mb-2">{{ form.featured.label }} {{ form.featured(class='form-select') }}</div>
            <div class="mt-2"><button class="btn btn-primary">Create</button></div>
          </form>
        </div>
      </div>
    </div>
    <div class="col-md-7">
      <div class="card mb-3">
        <div class="card-header">Products</div>
        <div class="table-responsive">
          <table class="table table-striped align-middle mb-0">
            <thead><tr><th>Name</th><th>Category</th><th>Price</th><th>Stock</th><th>Featured</th><th>Status</th><th></th></tr></thead>
            <tbody>
              {% for p in products %}
              <tr>
                <td>{{ p.name }}</td>
                <td>{{ p.category }}</td>
                <td>${{ '%.2f'|format(p.price) }}</td>
                <td>{{ p.inventory }}</td>
                <td>{{ 'Yes' if p.featured else 'No' }}</td>
                <td>{{ p.status }}</td>
                <td>
                  {# Removed invalid edit form endpoint; use edit via modal or future enhancement #}
                  <form method="post" action="{{ url_for('shop.admin_edit_product', product_id=p.id) }}" class="d-inline">
                    {{ csrf_token() }}
                    <input type="hidden" name="name" value="{{ p.name }}" />
                    <input type="hidden" name="description" value="{{ p.description }}" />
                    <input type="hidden" name="price" value="{{ '%.2f'|format(p.price) }}" />
                    <input type="hidden" name="category" value="{{ p.category }}" />
                    <input type="hidden" name="images" value="{{ p.images }}" />
                    <input type="hidden" name="status" value="{{ p.status }}" />
                    <input type="hidden" name="featured" value="{{ 'true' if p.featured else 'false' }}" />
                    <button class="btn btn-sm btn-outline-secondary">Quick Save</button>
                  </form>
                  <form method="post" action="{{ url_for('shop.admin_delete_product', product_id=p.id) }}" class="d-inline">{{ csrf_token() }} <button class="btn btn-sm btn-outline-danger">Delete</button></form>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span>Sales Report</span>
          <form method="get" class="d-flex align-items-end gap-2">
            <div>
              <label for="date_from" class="form-label mb-1 small">From</label>
              <input type="date" id="date_from" name="date_from" value="{{ date_from or '' }}" class="form-control form-control-sm" />
            </div>
            <div>
              <label for="date_to" class="form-label mb-1 small">To</label>
              <input type="date" id="date_to" name="date_to" value="{{ date_to or '' }}" class="form-control form-control-sm" />
            </div>
            <div class="pb-1 d-flex gap-2">
              <button class="btn btn-sm btn-primary" type="submit"><i class="bi bi-filter me-1"></i>Filter</button>
              <a href="{{ url_for('shop.admin_dashboard') }}" class="btn btn-sm btn-outline-secondary">Reset</a>
            </div>
          </form>
        </div>
        <div class="card-body">
          {% if date_from or date_to %}
            <div class="small text-muted mb-2">Filtering{% if date_from %} from <strong>{{ date_from }}</strong>{% endif %}{% if date_to %} to <strong>{{ date_to }}</strong>{% endif %}.</div>
          {% endif %}
          {% if sales_data is none %}
            <div class="text-muted">No sales yet.</div>
          {% else %}
            <div class="table-responsive">
              <table class="table table-sm">
                <thead><tr><th>Product</th><th>Units</th><th>Revenue</th></tr></thead>
                <tbody>
                  {% for row in sales_data %}
                    <tr>
                      <td>{{ row.name if row.name is defined else row['name'] }}</td>
                      <td>{{ row.units if row.units is defined else row['units'] }}</td>
                      <td>${{ '%.2f'|format(row.revenue if row.revenue is defined else row['revenue']) }}</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% endif %}
        </div>
      </div>

      <div class="card mt-3">
        <div class="card-header">Pending Reviews</div>
        <div class="card-body">
          {% if pending_reviews %}
          <div class="table-responsive">
            <table class="table table-striped table-sm align-middle mb-0">
              <thead><tr><th>Product</th><th>User</th><th>Rating</th><th>Excerpt</th><th>Date</th><th>Actions</th></tr></thead>
              <tbody>
                {% for r in pending_reviews %}
                <tr>
                  <td>{{ r.product.name if r.product else '—' }}</td>
                  <td>{{ r.user.username if r.user else '—' }}</td>
                  <td>{{ r.rating }}/5</td>
                  <td>{{ r.content[:60] ~ ('...' if r.content|length > 60 else '') }}</td>
                  <td>{{ r.created_at.strftime('%Y-%m-%d') }}</td>
                  <td>
                    <form method="post" action="{{ url_for('shop.admin_review_action', review_id=r.id, action='approve') }}" class="d-inline">{{ csrf_token() }}<button class="btn btn-sm btn-success">Approve</button></form>
                    <form method="post" action="{{ url_for('shop.admin_review_action', review_id=r.id, action='reject') }}" class="d-inline">{{ csrf_token() }}<button class="btn btn-sm btn-warning">Reject</button></form>
                    <form method="post" action="{{ url_for('shop.admin_review_action', review_id=r.id, action='delete') }}" class="d-inline">{{ csrf_token() }}<button class="btn btn-sm btn-outline-danger">Delete</button></form>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
            <div class="text-muted">No pending reviews.</div>
          {% endif %}
        </div>
      </div>

    </div>
  </div>
{% endblock %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js" integrity="sha256-q8m9QqP6r0XkA1RtUp5m3J8aGDKf2gRmqLnsw8lV7Vw=" crossorigin="anonymous"></script>
<script>
  (function(){
    const ctx = document.getElementById('metricsChart');
    if(!ctx) return;
    new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: ['Users','Products','Orders','Pending Posts'],
        datasets: [{
          data: [{{ users_count }}, {{ products_count }}, {{ orders_count }}, {{ pending_posts }}],
          backgroundColor: ['#2a7a4b','#0077b6','#ffd166','#d9534f'],
          borderWidth: 0
        }]
      },
      options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
    });
  })();
</script>
