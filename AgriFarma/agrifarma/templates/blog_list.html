{% extends 'layouts/base.html' %}
{% block title %}Knowledge Base{% endblock %}
{% block breadcrumb %}
  <a href="{{ url_for('main.index') }}" class="af-breadcrumb-home"><i class="bi bi-house-door-fill"></i><span class="visually-hidden">Home</span></a>
  <i class="bi bi-chevron-right separator" aria-hidden="true"></i>
  <span class="current">Knowledge Base</span>
{% endblock %}
{% block content %}

<!-- Knowledge Base Hero -->
<section class="af-kb-hero af-hero-cover af-overlay-dark" style="background-image: url('{{ url_for('static', filename='img/backgrounds/kb_hero_bg.jpg') }}'); background-size: cover; background-position: center;">
  <div class="container af-hero-inner">
    <div class="row align-items-center">
      <div class="col-lg-8">
        <h1 class="af-kb-title">Knowledge Base</h1>
        <p class="af-kb-sub">Practical guides, tips and stories from the farming community — searchable and curated.</p>
      </div>
      <div class="col-lg-4 text-lg-end mt-3 mt-lg-0">
        {% if current_user.is_authenticated %}
          <a href="{{ url_for('blog.new_post') }}" class="af-btn af-btn-primary"><i class="bi bi-plus-lg me-2"></i>New Article</a>
        {% endif %}
      </div>
    </div>
  </div>
</section>

<section class="container py-4">
  <div class="row g-4">
    <div class="col-lg-8">
      <div class="row row-cols-1 g-3">
        {% if posts %}
          {% for p in posts %}
          <article class="col">
            <a href="{{ url_for('blog.detail', post_id=p.id) }}" class="kb-card d-flex gap-3 text-decoration-none">
              <div class="kb-thumb" style="background-image: url('{{ url_for('static', filename='uploads/blog/' + (p.media_files.split(',')[0] if p.media_files else 'article_1.jpg')) }}')"></div>
              <div class="kb-body flex-grow-1">
                <h3 class="h5 mb-1 kb-title">{{ p.title }}</h3>
                <div class="kb-meta small text-muted">{{ p.category }} · {{ p.created_at.strftime('%b %d, %Y') }} · {{ p.comments|length if p.comments is defined else '' }} comments</div>
                <p class="kb-excerpt mt-2 text-muted">{{ p.content|striptags|truncate(160) }}</p>
                {% if p.tags %}
                  {% set _tags = p.tags.split(',') if p.tags else [] %}
                  <div class="kb-tags mt-2">
                    {% for t in _tags %}
                      <span class="badge rounded-pill bg-secondary kb-tag">{{ t.strip() }}</span>
                    {% endfor %}
                  </div>
                {% endif %}
              </div>
            </a>
          </article>
          {% endfor %}
        {% else %}
          <div class="text-muted">No articles found.</div>
        {% endif %}
      </div>

      {% if pagination and pagination.pages > 1 %}
      <nav aria-label="KB pagination" class="mt-4">
        <ul class="pagination pagination-sm">
          {% if pagination.has_prev %}
          <li class="page-item"><a class="page-link" href="?page={{ pagination.prev_num }}{% if search_query %}&q={{ search_query }}{% endif %}">Prev</a></li>
          {% endif %}
          {% for p in range(1, pagination.pages + 1) %}
          <li class="page-item {% if p==pagination.page %}active{% endif %}"><a class="page-link" href="?page={{ p }}{% if search_query %}&q={{ search_query }}{% endif %}">{{ p }}</a></li>
          {% endfor %}
          {% if pagination.has_next %}
          <li class="page-item"><a class="page-link" href="?page={{ pagination.next_num }}{% if search_query %}&q={{ search_query }}{% endif %}">Next</a></li>
          {% endif %}
        </ul>
      </nav>
      {% endif %}
    </div>

    <aside class="col-lg-4">
      <div class="card mb-3 af-kb-sidebar">
        <div class="card-body">
          <form class="af-kb-search" role="search" method="get" action="{{ url_for('blog.list_posts') }}">
            <div class="input-group">
              <input name="q" value="{{ search_query or '' }}" class="form-control" placeholder="Search title or tags" aria-label="Search">
              <button class="btn btn-primary" type="submit"><i class="bi bi-search"></i></button>
            </div>
          </form>
        </div>
      </div>

      <div class="card mb-3 af-kb-sidebar">
        <div class="card-header">Latest</div>
        <ul class="list-group list-group-flush">
          {% for p in latest_blog_posts %}
            <li class="list-group-item"><a class="text-decoration-none" href="{{ url_for('blog.detail', post_id=p.id) }}">{{ p.title }}</a></li>
          {% endfor %}
        </ul>
      </div>

      <div class="card af-kb-sidebar">
        <div class="card-header">Trending</div>
        <ul class="list-group list-group-flush">
          {% for p in trending_blog_posts %}
            <li class="list-group-item"><a class="text-decoration-none" href="{{ url_for('blog.detail', post_id=p.id) }}">{{ p.title }}</a></li>
          {% endfor %}
        </ul>
      </div>
    </aside>
  </div>
</section>

{% endblock %}
