{% extends 'base.html' %}
{% block content %}
<section class="af-forum-hero position-relative" style="background-image:url('{{ url_for('static', filename='img/backgrounds/forum_bg.jpg') }}')">
  <div class="af-forum-overlay"></div>
  <div class="container py-5 position-relative">
    <div class="row align-items-center mb-4">
      <div class="col-lg-8">
        <h1 class="display-5 fw-bold af-forum-title mb-3">Community Forum</h1>
        <p class="lead af-forum-subtitle mb-0">Ask questions, share experiences, and learn from experts & fellow growers.</p>
      </div>
      <div class="col-lg-4 text-lg-end mt-4 mt-lg-0">
        <a href="{{ url_for('forum.new_thread') }}" class="btn btn-primary btn-lg af-thread-cta"><i class="bi bi-plus-circle me-2"></i>Start a Thread</a>
      </div>
    </div>
    <div class="row g-4">
      <div class="col-lg-8 order-2 order-lg-1">
        <div class="af-category-grid">
          {% for c in categories %}
          <a href="{{ url_for('forum.category_view', category_id=c.id) }}" class="af-category-card">
            <div class="af-cat-icon">{{ c.name[:1] }}</div>
            <div class="af-cat-info">
              <h3 class="h6 mb-1">{{ c.name }}</h3>
              <div class="af-cat-meta small text-muted">{{ c.threads|length }} threads</div>
            </div>
            <div class="af-cat-arrow"><i class="bi bi-arrow-right"></i></div>
          </a>
          {% if c.children %}
          <div class="af-subcats mt-1 ms-2">
            <button class="btn btn-link btn-sm p-0" type="button" data-bs-toggle="collapse" data-bs-target="#subcats-{{ c.id }}" aria-expanded="false" aria-controls="subcats-{{ c.id }}">
              <i class="bi bi-chevron-down me-1"></i> Subcategories
            </button>
            <div class="collapse" id="subcats-{{ c.id }}">
              <div class="small mt-1">
                {% for child in c.children %}
                  <a href="{{ url_for('forum.category_view', category_id=child.id) }}" class="badge rounded-pill text-bg-light text-decoration-none me-1 mb-1">{{ child.name }}</a>
                {% endfor %}
              </div>
            </div>
          </div>
          {% endif %}
          {% endfor %}
        </div>

        {% if search_query is defined and search_query %}
        <div class="af-search-results mt-5">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h2 class="h5 mb-0"><i class="bi bi-search me-2"></i>Results for "{{ search_query }}"</h2>
            <a href="{{ url_for('forum.index') }}" class="small text-decoration-none">Clear</a>
          </div>
          <div class="af-results-list">
            {% if search_results %}
              {% for p in search_results %}
              <div class="af-result-item">
                <div class="af-result-header">
                  <a href="{{ url_for('forum.thread_view', thread_id=p.thread_id) }}" class="af-result-title">{{ p.thread.title }}</a>
                </div>
                <p class="af-result-excerpt mb-2">{{ p.content|truncate(160) }}</p>
                <a href="{{ url_for('forum.thread_view', thread_id=p.thread_id) }}" class="btn btn-sm btn-outline-primary">Open Thread</a>
              </div>
              {% endfor %}
            {% else %}
              <div class="text-muted">No matches found.</div>
            {% endif %}
          </div>
        </div>
        {% endif %}
      </div>
      <div class="col-lg-4 order-1 order-lg-2">
        {% include 'includes/forum_sidebar.html' %}
      </div>
    </div>
  </div>
</section>
{% endblock %}
